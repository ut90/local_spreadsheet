# グリッド見出し（2段ヘッダー）仕様

本書は、グリッドのカラム見出しが「階層あり」と「階層なし」を混在できる要件を定義します。セル結合（rowspan/colspan）を用いて、2段ヘッダーを正しく表現します。

## 用語
- 階層ありカラム: `group.child` のドット区切りキーを持つ列。例: `他システムサーバー.IP`
- 階層なしカラム: ドットを含まない単独キーの列。例: `自システム`, `プロトコル`
- グループ名: 階層ありカラムの上位（ドットの前部）。例: `他システムサーバー`
- サブ項目: 階層ありカラムの下位（ドットの後部）。例: `名称`, `ホスト`, `IP`

## 表示原則
- ヘッダーは2段構成（上段・下段）。
- 階層ありカラムは、上段に「グループ名」を1セル（colspan=子列数）で表示し、下段に各「サブ項目」を表示する。
- 階層なしカラムは、1セルで上段から下段へ縦結合（rowspan=2）し、下段では重複表示しない。
- 階層あり／なしを混在可能。横並び時、グループセルと縦結合セルが交互に配置されても整列を崩さない。
- 表示順は「最初のデータ行（または単一オブジェクト）のキー出現順」に従う。後続行で新しいキーが現れた場合は、初出順で末尾に追加する。同一グループ内のサブ項目も、初出順を尊重する。

## 列キーの生成（投影ルール要点）
- ネストはドット区切りのパスに展開。例: `meta.created_at`。
- オブジェクト配列（例: `自システムサーバー`, `他システムサーバー`）は二層列として集約する。
  - 配下の全フィールド名の和集合を取り、`<グループ>.<フィールド>` 列を生成。
  - 各列のセル値は、配列の各要素から当該フィールドを取り出し「、」で連結して1セルにまとめる。
  - 例: `他システムサーバー` が `[{ 名称, ホスト, IP }, ...]` なら、`他システムサーバー.名称`, `他システムサーバー.ホスト`, `他システムサーバー.IP` を生成し、行ごとのセルは `"auth-api-1、auth-api-2"` のように集約表示する。
- プリミティブ配列（数値/文字列など）や混在型配列は、`<キー>` 列（単層）として「、」連結で1セル表示する。

## セル表示ルール（抜粋）
- 空/未定義は空文字表示、null は `null`。
- 文字列/数値/真偽値はそのまま表示。
- オブジェクト/配列は JSON 文字列化して可視化（将来、専用レンダラで改善）。

## アクセシビリティ/レイアウト
- 上段セルはグループ名を、下段セルは子ラベルを持ち、スクリーンリーダー向けに `aria-colspan/rowspan` と `scope` を適用（将来対応）。
- 列幅は一定幅（例: 160px）を既定とし、列数に応じて横スクロール。

## 例（サンプルYAML）
YAML（抜粋）
```yaml
要件:
  - 名称: 認証API連携
    自システム: 受注管理システム
    自システムサーバー:
      - 名称: app-1
        ホスト: app1.local.example
        IP: 10.0.1.10
    他システム: 認証基盤
    他システムサーバー:
      - 名称: auth-api-1
        ホスト: auth1.partner.example.com
        IP: 172.16.10.20
```
生成される列（例）
- 階層なし: `名称`, `自システム`, `他システム`, `プロトコル`, `ポート`, ...
- 階層あり: `自システムサーバー.名称`, `自システムサーバー.ホスト`, `自システムサーバー.IP`, `他システムサーバー.名称`, `他システムサーバー.ホスト`, `他システムサーバー.IP`

ヘッダー表示
- 上段: `自システム`（rowspan=2）、`自システムサーバー`（colspan=3）、`他システム`（rowspan=2）、`他システムサーバー`（colspan=3）…
- 下段: `名称/ホスト/IP`（各グループの子項目）。単層の `自システム` などは下段には表示しない。

## 実装ノート（MVP）
- ヘッダーは `table thead` で実装し、rowspan/colspan を使用。ボディは仮想スクロール（div）で高パフォーマンスを維持。
- 列幅は `colgroup` で同期。
- キー順や表示/非表示は将来 `Settings` でカスタマイズ可能にする（`grid.hiddenColumns`）。

## 行マージ（縦方向のセル結合）
- トップレベル配列要素（例: `要件` の各項目）に、配下のオブジェクト配列グループ（例: `自システムサーバー`, `他システムサーバー`）が含まれる場合、行は「サブ行」に展開する。
  - サブ行数は、当該グループ群の要素数の最大値（例: 自=2台、他=1台 → サブ行=2）。
  - 階層なしカラムは、サブ行全体で1セルに縦結合（rowspan=サブ行数）。
  - 階層ありカラムは、サブ行ごとに i 番目の要素の値を表示（要素が存在しなければ空）。
- これにより、例「認証API連携」で自システムサーバーが2台あれば、当該行は2サブ行になり、名称やプロトコル等は縦結合で1度だけ表示される。
